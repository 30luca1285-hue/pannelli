<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>â˜€ï¸ Pannelli Solari â€” Dashboard</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0A1628">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--sun:#F5A623;--sun-bright:#FFD060;--sky:#0A1628;--sky-mid:#0F2040;--sky-light:#162850;--green:#2ECC71;--green-dim:#1a7a44;--blue:#3498DB;--red:#E74C3C;--text:#E8EDF5;--text-dim:#7A8BA8;--border:rgba(245,166,35,0.15);--card-bg:rgba(15,32,64,0.8)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Syne',sans-serif;background:var(--sky);color:var(--text);min-height:100vh;overflow-x:hidden;-webkit-text-size-adjust:100%}
body::before{content:'';position:fixed;top:-200px;right:-200px;width:700px;height:700px;background:radial-gradient(circle,rgba(245,166,35,0.08) 0%,transparent 70%);pointer-events:none;z-index:0}
.grid-bg{position:fixed;inset:0;background-image:linear-gradient(rgba(245,166,35,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(245,166,35,0.04) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}
.container{position:relative;z-index:1;max-width:1400px;margin:0 auto;padding:24px}
header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid var(--border)}
.logo-area h1{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:var(--sun);letter-spacing:-0.5px}
.logo-area p{font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);margin-top:4px;letter-spacing:1px;text-transform:uppercase}
.header-meta{text-align:right}
.live-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(46,204,113,0.1);border:1px solid rgba(46,204,113,0.3);color:var(--green);padding:4px 12px;border-radius:20px;font-family:'Space Mono',monospace;font-size:11px;letter-spacing:1px}
.live-dot{width:7px;height:7px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(0.8)}}
.last-update{font-family:'Space Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:8px}
.tabs{display:flex;gap:2px;margin-bottom:28px;background:var(--sky-mid);border-radius:10px;padding:4px;width:fit-content;border:1px solid var(--border)}
.tab{padding:8px 20px;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;color:var(--text-dim);border:none;background:none;font-family:'Syne',sans-serif}
.tab.active{background:var(--sun);color:var(--sky)}.tab:hover:not(.active){color:var(--text);background:rgba(245,166,35,0.1)}
.panel{display:none}.panel.active{display:block}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:28px}
.kpi-card{background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:20px;position:relative;overflow:hidden;backdrop-filter:blur(10px);transition:transform 0.2s,border-color 0.2s}
.kpi-card:hover{transform:translateY(-2px);border-color:rgba(245,166,35,0.35)}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--sun),transparent)}
.kpi-label{font-family:'Space Mono',monospace;font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px}
.kpi-value{
  font-size:36px;
  font-weight:800;
  color:var(--sun);
  line-height:1.1;
  letter-spacing:1px;
  font-family:'Space Mono', monospace;
}
.kpi-unit{font-family:'Space Mono',monospace;font-size:12px;color:var(--text-dim)}
.kpi-sub{font-family:'Space Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.05)}
.kpi-sub.positive{color:var(--green)}.kpi-sub.negative{color:var(--red)}
.chart-row{display:grid;gap:20px;margin-bottom:24px}.chart-row.cols-2{grid-template-columns:1fr 1fr}.chart-row.cols-3{grid-template-columns:2fr 1fr}
.chart-card{background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:24px;backdrop-filter:blur(10px)}
.chart-card h3{font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
.chart-card .chart-sub{font-family:'Space Mono',monospace;font-size:10px;color:var(--text-dim);margin-bottom:20px}
.chart-wrapper{position:relative}
.year-pills{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.year-pill{padding:4px 12px;border-radius:20px;font-family:'Space Mono',monospace;font-size:11px;cursor:pointer;border:1px solid var(--border);background:none;color:var(--text-dim);transition:all 0.2s}
.year-pill.active{background:rgba(245,166,35,0.15);border-color:var(--sun);color:var(--sun)}
.data-table{width:100%;border-collapse:collapse;font-family:'Space Mono',monospace;font-size:12px}
.data-table th{background:rgba(245,166,35,0.08);color:var(--sun);font-size:10px;text-transform:uppercase;letter-spacing:1px;padding:10px 14px;text-align:left;border-bottom:1px solid var(--border)}
.data-table td{padding:9px 14px;color:var(--text);border-bottom:1px solid rgba(255,255,255,0.04);transition:background 0.1s}
.data-table tr:hover td{background:rgba(245,166,35,0.04)}.data-table .num{text-align:right}.data-table .good{color:var(--green)}.data-table .warn{color:var(--sun)}
.amm-section{background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:24px;backdrop-filter:blur(10px)}
.amm-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px}
.amm-title{font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:1px}
.amm-nums{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:20px}
.amm-num-item{text-align:center}
.amm-num-label{font-family:'Space Mono',monospace;font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.amm-num-value{font-size:22px;font-weight:800}
.amm-num-value.invested{color:var(--text)}.amm-num-value.recovered{color:var(--green)}.amm-num-value.remaining{color:var(--sun)}
.progress-bar-bg{height:12px;background:rgba(255,255,255,0.06);border-radius:6px;overflow:hidden}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--sun));border-radius:6px;transition:width 1s ease;position:relative}
.progress-bar-fill::after{content:'';position:absolute;right:0;top:0;bottom:0;width:3px;background:white;border-radius:2px;box-shadow:0 0 8px rgba(255,255,255,0.5)}
.progress-label{display:flex;justify-content:space-between;margin-top:8px;font-family:'Space Mono',monospace;font-size:10px;color:var(--text-dim)}
/* LIVE STYLES */
.energy-flow{display:grid;grid-template-columns:1fr 1.5fr 1fr;grid-template-rows:auto auto auto;gap:16px;margin-bottom:28px;align-items:center}
.flow-node{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;padding:24px;text-align:center;backdrop-filter:blur(10px);transition:all 0.3s}
.flow-node:hover{border-color:rgba(245,166,35,0.4)}
.flow-node .node-icon{font-size:40px;margin-bottom:8px;display:block}
.flow-node .node-label{font-family:'Space Mono',monospace;font-size:12px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px}
.flow-node .node-power{
  font-size:42px;
  font-weight:800;
  line-height:1.1;
  margin-bottom:6px;
  letter-spacing:1.5px;
  font-family:'Space Mono', monospace;
}
.flow-node .node-unit{font-family:'Space Mono',monospace;font-size:13px;color:var(--text-dim)}
.flow-node .node-energy{font-family:'Space Mono',monospace;font-size:13px;color:var(--text-dim);margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.06)}
.flow-pv{grid-column:2;grid-row:1;border-color:rgba(245,166,35,0.3)}.flow-pv .node-power{color:var(--sun)}
.flow-battery{grid-column:1;grid-row:2;border-color:rgba(52,152,219,0.3)}.flow-battery .node-power{color:var(--blue)}
.flow-inverter{grid-column:2;grid-row:2;border-color:rgba(255,255,255,0.2);background:rgba(20,40,80,0.9)}
.flow-grid{grid-column:1;grid-row:3;border-color:rgba(231,76,60,0.3)}.flow-grid .node-power{color:var(--red)}
.flow-house{grid-column:3;grid-row:2;border-color:rgba(46,204,113,0.3)}.flow-house .node-power{color:var(--green)}
.gauge-container{display:flex;flex-direction:column;align-items:center;justify-content:center}
.gauge-ring{width:140px;height:140px;border-radius:50%;background:conic-gradient(var(--green) 0deg,var(--green) calc(var(--gauge-pct,0)*3.6deg),rgba(255,255,255,0.06) calc(var(--gauge-pct,0)*3.6deg));display:flex;align-items:center;justify-content:center}
.gauge-inner{width:110px;height:110px;border-radius:50%;background:var(--sky-mid);display:flex;flex-direction:column;align-items:center;justify-content:center}
.gauge-value{font-size:32px;font-weight:800;color:var(--green);line-height:1}
.gauge-label{font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;margin-top:4px}
.batt-visual{width:60px;height:100px;border:3px solid var(--blue);border-radius:6px;position:relative;margin:0 auto 8px;overflow:hidden}
.batt-visual::before{content:'';position:absolute;top:-8px;left:50%;transform:translateX(-50%);width:24px;height:6px;background:var(--blue);border-radius:2px 2px 0 0}
.batt-fill{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(180deg,var(--blue),rgba(52,152,219,0.4));transition:height 1s ease}
.batt-pct{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:16px;font-weight:700;color:white;text-shadow:0 1px 3px rgba(0,0,0,0.5);z-index:1}
.live-status{display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:20px}
.live-status-text{font-family:'Space Mono',monospace;font-size:13px;color:var(--text-dim)}
.setup-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.setup-card{background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:24px;backdrop-filter:blur(10px)}
.setup-card h3{font-size:14px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.step-list{list-style:none}
.step-item{display:flex;gap:14px;align-items:flex-start;margin-bottom:16px}
.step-num{width:26px;height:26px;min-width:26px;background:rgba(245,166,35,0.15);border:1px solid var(--sun);color:var(--sun);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:11px;font-weight:700}
.step-content{flex:1}.step-title{font-size:13px;font-weight:600;margin-bottom:4px}
.step-desc{font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);line-height:1.6}
.code-block{background:rgba(0,0,0,0.4);border:1px solid rgba(245,166,35,0.2);border-radius:8px;padding:14px;font-family:'Space Mono',monospace;font-size:11px;line-height:1.8;margin-top:12px;overflow-x:auto}
.code-comment{color:#556B8A}.code-key{color:var(--sun)}.code-val{color:var(--green)}.code-str{color:#82CFAF}
.info-box{background:rgba(52,152,219,0.08);border:1px solid rgba(52,152,219,0.25);border-radius:8px;padding:14px;font-family:'Space Mono',monospace;font-size:11px;color:var(--blue);line-height:1.7;margin-top:12px}
.warn-box{background:rgba(245,166,35,0.08);border:1px solid rgba(245,166,35,0.25);border-radius:8px;padding:14px;font-family:'Space Mono',monospace;font-size:11px;color:var(--sun);line-height:1.7;margin-top:12px}
.price-bar{display:flex;gap:16px;align-items:center;justify-content:center;margin-bottom:20px;padding:12px 20px;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;backdrop-filter:blur(10px);flex-wrap:wrap}
.price-bar label{font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);display:flex;align-items:center;gap:6px}
.price-bar input{width:70px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:6px;padding:5px 8px;color:var(--sun);font-family:'Space Mono',monospace;font-size:12px;text-align:right;outline:none;transition:border-color 0.2s}
.price-bar input:focus{border-color:var(--sun)}
.price-bar .price-unit{font-family:'Space Mono',monospace;font-size:10px;color:var(--text-dim)}
.price-bar .price-saved{font-family:'Space Mono',monospace;font-size:10px;color:var(--green);opacity:0;transition:opacity 0.3s}
.price-bar .price-saved.show{opacity:1}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:var(--sky)}::-webkit-scrollbar-thumb{background:rgba(245,166,35,0.3);border-radius:3px}
@media(max-width:900px){
.chart-row.cols-2,.chart-row.cols-3,.setup-grid{grid-template-columns:1fr}
.kpi-grid{grid-template-columns:repeat(2,1fr)}
.energy-flow{grid-template-columns:1fr}
.flow-pv,.flow-battery,.flow-inverter,.flow-grid,.flow-house{grid-column:1;grid-row:auto}
}
@media(max-width:480px){
.container{padding:12px 10px}
header{flex-direction:column;gap:12px;margin-bottom:20px;padding-bottom:16px}
.logo-area h1{font-size:20px}
.logo-area p{font-size:9px;letter-spacing:0.5px}
.header-meta{text-align:left;display:flex;align-items:center;gap:10px}
.live-badge{font-size:10px;padding:3px 10px}
.last-update{font-size:9px;margin-top:0}
.tabs{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;gap:1px;padding:3px;border-radius:8px;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:8px 14px;font-size:11px;white-space:nowrap;min-height:38px;border-radius:6px}
.kpi-grid{grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
.kpi-card{padding:14px;border-radius:10px}
.kpi-label{font-size:9px;letter-spacing:1px;margin-bottom:6px}
.kpi-value{font-size:24px}
.kpi-unit{font-size:10px}
.kpi-sub{font-size:9px;margin-top:6px;padding-top:6px}
.chart-card{padding:14px;border-radius:10px}
.chart-card h3{font-size:12px;letter-spacing:0.5px}
.chart-card .chart-sub{font-size:9px;margin-bottom:14px}
.energy-flow{gap:10px;margin-bottom:20px}
.flow-node{padding:16px;border-radius:12px}
.flow-node .node-icon{font-size:30px;margin-bottom:6px}
.flow-node .node-label{font-size:11px;letter-spacing:1px;margin-bottom:6px}
.flow-node .node-power{font-size:30px;letter-spacing:1px}
.flow-node .node-unit{font-size:12px}
.flow-node .node-energy{font-size:12px;margin-top:8px;padding-top:8px}
.gauge-ring{width:110px;height:110px}
.gauge-inner{width:85px;height:85px}
.gauge-value{font-size:24px}
.gauge-label{font-size:10px}
.batt-visual{width:50px;height:80px}
.batt-pct{font-size:14px}
.price-bar{flex-direction:column;gap:10px;padding:12px 14px;border-radius:10px}
.price-bar label{font-size:10px;width:100%;justify-content:space-between}
.price-bar input{width:80px;padding:8px 10px;font-size:13px;min-height:38px;border-radius:8px}
.live-status{margin-bottom:14px}
.live-status-text{font-size:12px;text-align:center;line-height:1.5}
.amm-section{padding:16px;border-radius:10px;margin-bottom:18px}
.amm-header{flex-direction:column;gap:8px}
.amm-nums{grid-template-columns:1fr;gap:12px;margin-bottom:14px}
.amm-num-item{text-align:left;display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.amm-num-label{font-size:9px;margin-bottom:0}
.amm-num-value{font-size:18px}
.progress-label{font-size:9px}
.year-pills{gap:4px;margin-bottom:14px}
.year-pill{padding:6px 14px;font-size:11px;min-height:34px;display:flex;align-items:center}
.data-table{font-size:10px}
.data-table th{font-size:8px;padding:8px 6px;letter-spacing:0.5px}
.data-table td{padding:8px 6px}
.chart-card>div:has(.data-table){overflow-x:auto;-webkit-overflow-scrolling:touch}
.setup-card{padding:16px;border-radius:10px;margin-bottom:14px}
.setup-card h3{font-size:12px}
.step-desc{font-size:10px;line-height:1.5}
.code-block{font-size:10px;padding:10px;line-height:1.6}
.info-box,.warn-box{font-size:10px;padding:10px;line-height:1.5}
#kpiAnni{grid-template-columns:1fr 1fr !important}
}
</style>
</head>
<body>
<div class="grid-bg"></div>
<div class="container">
<header>
<div class="logo-area"><h1>â˜€ PEIMAR SF340M</h1><p>Impianto fotovoltaico Â· Inverter Delios Â· Monitoraggio 2022â€“2026</p></div>
<div class="header-meta"><div class="live-badge"><span class="live-dot"></span> <span id="statusBadge">DATI STORICI</span></div><div class="last-update" id="updateTime"></div></div>
</header>

<div class="tabs">
<button class="tab active" onclick="switchTab('live')">âš¡ Live Inverter</button>
<button class="tab" onclick="switchTab('overview')">Overview</button>
<button class="tab" onclick="switchTab('mensile')">Mensile</button>
<button class="tab" onclick="switchTab('confronto')">Confronto Anni</button>
<button class="tab" onclick="switchTab('setup')">Setup API</button>
</div>

<!-- LIVE INVERTER -->
<div id="tab-live" class="panel active">
<div class="live-status"><div class="live-dot"></div><div class="live-status-text">Dati dal portale Delios Â· Aggiornamento ogni 15 min Â· <span id="liveTimestamp">In attesa...</span></div></div>
<div class="price-bar">
<label>ğŸ’° Acquisto: <input type="number" id="price-acquisto" step="0.01" min="0" value="0.28"> <span class="price-unit">â‚¬/kWh</span></label>
<label>ğŸ’¸ Vendita: <input type="number" id="price-vendita" step="0.01" min="0" value="0.10"> <span class="price-unit">â‚¬/kWh</span></label>
<span class="price-saved" id="priceSaved">Salvato!</span>
</div>
<div class="energy-flow">
<div class="flow-node flow-pv"><span class="node-icon">â˜€ï¸</span><div class="node-label">Fotovoltaico</div><div class="node-power" id="live-powerpv">â€”</div><div class="node-unit">kW istantanei</div><div class="node-energy">Oggi: <strong id="live-energypv">â€”</strong> kWh</div>
<div class="node-energy">Valore: <strong id="live-euro-pv">â€”</strong> â‚¬</div></div>
<div class="flow-node flow-battery"><div class="batt-visual"><div class="batt-fill" id="live-battfill" style="height:0%"></div><div class="batt-pct" id="live-battpct">0%</div></div><div class="node-label">Batteria</div><div class="node-power" id="live-powerbatt" style="font-size:24px;">â€”</div><div class="node-unit">kW</div><div class="node-energy">Scarica: <strong id="live-battdischa">â€”</strong> Â· Carica: <strong id="live-battchar">â€”</strong> kWh</div></div>
<div class="flow-node flow-inverter gauge-container"><div class="gauge-ring" id="live-gauge" style="--gauge-pct:0"><div class="gauge-inner"><div class="gauge-value" id="live-selfsuff">â€”</div><div class="gauge-label">Autosufficienza</div></div></div><div style="font-family:'Space Mono',monospace;font-size:12px;color:var(--text-dim);margin-top:12px;">INVERTER DELIOS</div></div>
<div class="flow-node flow-house"><span class="node-icon">ğŸ </span><div class="node-label">Carichi Casa</div><div class="node-power" id="live-powerhouse">â€”</div><div class="node-unit">kW istantanei</div><div class="node-energy">Oggi: <strong id="live-energyhouse">â€”</strong> kWh</div></div>
<div class="flow-node flow-grid"><span class="node-icon">ğŸ”Œ</span><div class="node-label">Rete Elettrica</div><div class="node-power" id="live-powergrid">â€”</div><div class="node-unit">kW</div><div class="node-energy">Prelevata: <strong id="live-gridcons">â€”</strong> Â· Immessa: <strong id="live-gridfeed">â€”</strong> kWh</div>
<div class="node-energy">Costo prelevata: <strong id="live-euro-cons" style="color:var(--red)">â€”</strong> â‚¬ Â· Valore immessa: <strong id="live-euro-feed" style="color:var(--green)">â€”</strong> â‚¬</div></div>
</div>
<div class="chart-row cols-2">
<div class="chart-card"><h3>Potenza nelle ultime 24h</h3><div class="chart-sub">kW â€” PV / Casa / Rete / Batteria</div><div class="chart-wrapper"><canvas id="chartLivePower" height="220"></canvas></div></div>
<div class="chart-card"><h3>Energia Cumulata Oggi</h3><div class="chart-sub">kWh â€” Produzione vs Consumo vs Rete</div><div class="chart-wrapper"><canvas id="chartLiveEnergy" height="220"></canvas></div></div>
</div>
<div class="chart-row cols-2">
<div class="chart-card"><h3>Autosufficienza nelle ultime 24h</h3><div class="chart-sub">% â€” Quanta energia viene dal sole</div><div class="chart-wrapper"><canvas id="chartLiveSelfSuff" height="180"></canvas></div></div>
<div class="chart-card"><h3>Batteria nelle ultime 24h</h3><div class="chart-sub">% â€” Stato di carica</div><div class="chart-wrapper"><canvas id="chartLiveBattery" height="180"></canvas></div></div>
</div>
</div>

<!-- OVERVIEW -->
<div id="tab-overview" class="panel">
<div class="amm-section"><div class="amm-header"><div><div class="amm-title">ğŸ’° Ammortamento Investimento</div><div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);margin-top:4px;">Investimento iniziale: â‚¬24.000</div></div><div style="font-family:'Space Mono',monospace;font-size:22px;font-weight:700;color:var(--green);" id="ammPerc">â€”</div></div>
<div class="amm-nums"><div class="amm-num-item"><div class="amm-num-label">Investimento</div><div class="amm-num-value invested">â‚¬24.000</div></div><div class="amm-num-item"><div class="amm-num-label">Recuperato</div><div class="amm-num-value recovered" id="ammRecov">â€”</div></div><div class="amm-num-item"><div class="amm-num-label">Da recuperare</div><div class="amm-num-value remaining" id="ammRemain">â€”</div></div></div>
<div class="progress-bar-bg"><div class="progress-bar-fill" id="ammBar" style="width:0%"></div></div>
<div class="progress-label"><span>Maggio 2022</span><span id="ammPercLabel">0%</span><span>Obiettivo: â‚¬0</span></div></div>
<div class="kpi-grid">
<div class="kpi-card"><div class="kpi-label">âš¡ Produzione Totale</div><div class="kpi-value" id="kpi-prod">â€”</div><div class="kpi-unit">kWh prodotti</div><div class="kpi-sub" id="kpi-prod-sub">â€”</div></div>
<div class="kpi-card"><div class="kpi-label">ğŸ”‹ Autoconsumo Medio</div><div class="kpi-value" id="kpi-auto">â€”</div><div class="kpi-unit">% produzione consumata</div><div class="kpi-sub">Media su tutti i mesi</div></div>
<div class="kpi-card"><div class="kpi-label">ğŸŒ Rete Immessa</div><div class="kpi-value" id="kpi-immessa">â€”</div><div class="kpi-unit">kWh ceduti alla rete</div><div class="kpi-sub" id="kpi-immessa-sub">â€”</div></div>
<div class="kpi-card"><div class="kpi-label">ğŸ’¡ Migliore Mese</div><div class="kpi-value" id="kpi-best">â€”</div><div class="kpi-unit">kWh</div><div class="kpi-sub" id="kpi-best-sub">â€”</div></div>
<div class="kpi-card"><div class="kpi-label">ğŸ’¸ Costo Medio â‚¬/kWh</div><div class="kpi-value" id="kpi-cost">â€”</div><div class="kpi-unit">materia energia</div><div class="kpi-sub" id="kpi-cost-sub">â€”</div></div>
<div class="kpi-card"><div class="kpi-label">ğŸ“… Mesi di Dati</div><div class="kpi-value" id="kpi-months">â€”</div><div class="kpi-unit">mesi tracciati</div><div class="kpi-sub">Maggio 2022 â†’ Gen 2026</div></div>
</div>
<div class="chart-row cols-3"><div class="chart-card"><h3>Produzione Mensile kWh</h3><div class="chart-sub">Tutti gli anni sovrapposti</div><div class="chart-wrapper"><canvas id="chartProduzione" height="220"></canvas></div></div><div class="chart-card"><h3>Produzione per Anno</h3><div class="chart-sub">Totale annuale kWh</div><div class="chart-wrapper"><canvas id="chartAnni" height="220"></canvas></div></div></div>
<div class="chart-row cols-2"><div class="chart-card"><h3>Costo â‚¬/kWh Materia Energia</h3><div class="chart-sub">Evoluzione storica del prezzo</div><div class="chart-wrapper"><canvas id="chartCosto" height="200"></canvas></div></div><div class="chart-card"><h3>Autoconsumo vs Immissione</h3><div class="chart-sub">kWh mensili â€” media 2024</div><div class="chart-wrapper"><canvas id="chartDonut" height="200"></canvas></div></div></div>
</div>

<!-- MENSILE -->
<div id="tab-mensile" class="panel">
<div class="year-pills" id="yearPills"></div>
<div class="chart-card" style="margin-bottom:20px;"><h3 id="mensileTitle">Dettaglio Mensile</h3><div class="chart-sub">Produzione Â· Autoconsumo Â· Immessa in rete Â· Bolletta kWh</div><div class="chart-wrapper"><canvas id="chartMensile" height="240"></canvas></div></div>
<div class="chart-card"><div style="overflow-x:auto;"><table class="data-table" id="tableMensile"><thead><tr><th>Mese</th><th class="num">Produzione FV</th><th class="num">Autoconsumo</th><th class="num">Immessa rete</th><th class="num">Da rete</th><th class="num">Bolletta kWh</th><th class="num">â‚¬/kWh</th><th class="num">Costo â‚¬</th></tr></thead><tbody id="tbodyMensile"></tbody></table></div></div>
</div>

<!-- CONFRONTO -->
<div id="tab-confronto" class="panel">
<div class="kpi-grid" id="kpiAnni" style="grid-template-columns:repeat(5,1fr);"></div>
<div class="chart-row cols-2" style="margin-top:20px;"><div class="chart-card"><h3>Produzione Mensile per Anno</h3><div class="chart-sub">kWh â€” confronto stagionale</div><div class="chart-wrapper"><canvas id="chartConfronto" height="260"></canvas></div></div><div class="chart-card"><h3>Costo â‚¬/kWh per Anno</h3><div class="chart-sub">Evoluzione prezzi energia</div><div class="chart-wrapper"><canvas id="chartCostoAnno" height="260"></canvas></div></div></div>
</div>

<!-- SETUP API -->
<div id="tab-setup" class="panel">
<div class="setup-grid">
<div>
<div class="setup-card" style="margin-bottom:20px;"><h3>ğŸ”Œ Architettura â€” API Cloud Delios</h3>
<p style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);line-height:1.8;margin-bottom:12px;">Reverse engineering del portale <strong style="color:var(--sun)">webportal.delios-srl.it</strong>. Google Apps Script chiama le API REST del backend Delios ogni 15 minuti.</p>
<div style="background:rgba(0,0,0,0.3);border-radius:10px;padding:16px;border:1px solid var(--border);"><div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);margin-bottom:8px;">ARCHITETTURA</div><div style="font-family:'Space Mono',monospace;font-size:12px;line-height:2.2;"><span style="color:var(--sun)">Inverter Delios</span> (a casa)<br><span style="color:var(--text-dim)">â†“ WiFi â†’ cloud Delios</span><br><span style="color:var(--blue)">webportal-backend.delios-srl.it</span><br><span style="color:var(--text-dim)">â†“ API REST + JWT auth</span><br><span style="color:var(--green)">Google Apps Script</span> (trigger ogni 15 min)<br><span style="color:var(--text-dim)">â†“ scrive su</span><br><span style="color:var(--sun)">Google Sheets â†’ Dashboard</span></div></div></div>
<div class="setup-card"><h3>ğŸ“¡ API Endpoints</h3><div class="code-block"><span class="code-comment">// Autenticazione</span><br>POST <span class="code-str">/authenticate</span><br>Body: <span class="code-val">{"email":"...","password":"..."}</span><br>â†’ Token JWT (30 giorni)<br><br><span class="code-comment">// Dati real-time</span><br>POST <span class="code-str">/machine_logs/get_machine_log_general</span><br>Body: <span class="code-val">{"plant_id":1463,"machine_id":""}</span><br>â†’ powerpv, powergrid, powerhouse, battery...<br><br><span class="code-comment">// Trend storici</span><br>POST <span class="code-str">/machine_logs/get_machine_log_trend</span><br>â†’ type: day, week, month, year</div></div>
</div>
<div>
<div class="setup-card" style="margin-bottom:20px;"><h3>âš™ï¸ Setup in 3 passi</h3><ul class="step-list"><li class="step-item"><div class="step-num">1</div><div class="step-content"><div class="step-title">Copia DeliosAPI.gs</div><div class="step-desc">Google Sheets â†’ Estensioni â†’ Apps Script â†’ Nuovo file "DeliosAPI.gs"</div></div></li><li class="step-item"><div class="step-num">2</div><div class="step-content"><div class="step-title">Configura credenziali</div><div class="step-desc">In getConfig() inserisci la tua password Delios.</div></div></li><li class="step-item"><div class="step-num">3</div><div class="step-content"><div class="step-title">Esegui setupDelios()</div><div class="step-desc">CreerÃ  i fogli e imposterÃ  trigger automatici ogni 15 min.</div></div></li></ul><div class="info-box">â„¹ï¸ Dopo il setup, un menu "â˜€ï¸ Delios Solar" apparirÃ  in Google Sheets.</div></div>
<div class="setup-card"><h3>ğŸ“Š Fogli creati</h3><ul class="step-list"><li class="step-item"><div class="step-num">L</div><div class="step-content"><div class="step-title">Delios_Live</div><div class="step-desc">Ultimo valore di ogni parametro. Aggiornato ogni 15 min.</div></div></li><li class="step-item"><div class="step-num">S</div><div class="step-content"><div class="step-title">Delios_Storico</div><div class="step-desc">Log ogni 15 min. Max 10.000 righe (~100 giorni).</div></div></li><li class="step-item"><div class="step-num">G</div><div class="step-content"><div class="step-title">Delios_Giornaliero</div><div class="step-desc">Riepilogo giornaliero creato alle 23:50.</div></div></li></ul><div class="warn-box">âš ï¸ Token JWT dura 30 giorni. Rinnovo automatico.</div></div>
</div>
</div>
</div>

</div>
<script>
// ===================== APPS SCRIPT API =====================
const GAS_API = 'https://script.google.com/macros/s/AKfycbxXVLk-UsEycb1ItdqnjGqdmIULCTazUbVf1SE7xK8184eDrVWT4FwBcddtP_sUrfY9Ug/exec';

async function gasGet(action, params = {}) {
  const url = new URL(GAS_API);
  url.searchParams.set('action', action);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
  try {
    const res = await fetch(url.toString());
    return await res.json();
  } catch (e) {
    console.warn('GAS API error [' + action + ']:', e);
    return null;
  }
}
// ============================================================

const rawData = [
[2022,"Maggio",532,53,6.89,241,277,27.7,455,49.05,0.1078],
[2022,"Giugno",1581,185,24.05,473,1048,136.24,221,29,0.1312],
[2022,"Luglio",1637,244,31.72,288,1301,169.91,268,35,0.1306],
[2022,"Agosto",1529,376,236.88,377,1118,896.94,440,353,0.8023],
[2022,"Settembre",1004,190,93.1,271,725,355.25,244,121,0.49],
[2022,"Ottobre",939,192,94.08,182,741,525.38,244,173,0.709],
[2022,"Novembre",482,600,425.41,52,411,175.09,669,285,0.426],
[2022,"Dicembre",342,1218,518.88,11,321,154.08,1207,585,0.4847],
[2023,"Gennaio",408,948,305.77,23,374,120.63,927,299,0.3225],
[2023,"Febbraio",723,644,206.86,127,585,187.91,660,212,0.3212],
[2023,"Marzo",940,352,116.72,214,700,232.11,380,126,0.3316],
[2023,"Aprile",960,246,101.35,267,676,278.51,250,103,0.412],
[2023,"Maggio",1010,215,48.16,331,673,150.75,250,56,0.224],
[2023,"Giugno",1366,116,32.88,403,960,272.13,127,36,0.2835],
[2023,"Luglio",1545,267,61.15,340,1189,272.32,310,71,0.229],
[2023,"Agosto",1473,362,76.26,385,1070,225.41,375,79,0.2107],
[2023,"Settembre",1132,304,65.41,242,875,188.26,330,71,0.2152],
[2023,"Ottobre",760,383,98.02,122,622,159.18,465,119,0.2559],
[2023,"Novembre",533,588,136.4,24,496,115.06,638,148,0.232],
[2023,"Dicembre",535,1059,220.46,17,507,105.55,1100,229,0.2082],
[2024,"Gennaio",524,746,122.51,28,483,79.32,749,123,0.1642],
[2024,"Febbraio",712,480,75.74,98,599,94.51,488,77,0.1578],
[2024,"Marzo",855,436,68.89,214,622,98.28,462,73,0.158],
[2024,"Aprile",1157,191,37.25,412,718,140.01,200,39,0.195],
[2024,"Maggio",1245,123,26.62,425,805,174.22,134,29,0.2164],
[2024,"Giugno",1250,175,36.94,347,876,184.93,180,38,0.2111],
[2024,"Luglio",1548,530,103.08,276,1248,242.73,509,99,0.1945],
[2024,"Agosto",1437,706,139.53,197,1215,240.13,678,134,0.1976],
[2024,"Settembre",1033,379,73.55,255,759,147.3,371,72,0.1941],
[2024,"Ottobre",539,503,90.54,124,106,19.08,500,90,0.18],
[2024,"Novembre",521,960,184.07,48,460,88.2,944,181,0.1917],
[2024,"Dicembre",426,1225,249,13,328,66.67,1225,249,0.2033],
[2025,"Gennaio",445,1210,231.72,14,423,81.01,1248,239,0.1915],
[2025,"Febbraio",511,951,181.39,17,483,92.13,1101,210,0.1907],
[2025,"Marzo",954,627,118.38,183,745,140.66,625,118,0.1888],
[2025,"Aprile",1030,370,74.2,302,722,144.8,364,73,0.2005],
[2025,"Maggio",1170,222,48.56,312,846,185.06,224,49,0.2188],
[2025,"Giugno",1507,414,84.24,352,1144,232.77,403,82,0.2035],
[2025,"Luglio",1524,602,126.41,271,1233,258.91,581,122,0.21],
[2025,"Agosto",1367,517,101.96,205,1142,225.22,502,99,0.1972],
[2025,"Settembre",1110,319,66.07,233,864,178.95,309,64,0.2071],
[2025,"Ottobre",800,407,81.4,196,587,117.4,400,80,0.2],
[2025,"Novembre",524,888,154.87,50,460,80.23,883,154,0.1744],
[2025,"Dicembre",415,1461,254.09,10,398,69.22,1449,252,0.1739],
[2026,"Gennaio",392,1549,277,7,376,67.24,1549,277,0.1788],
];

const INVESTIMENTO=24000;
const mesiNomi=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
const anni=[...new Set(rawData.map(d=>d[0]))];
const colori={2022:'#E74C3C',2023:'#F5A623',2024:'#2ECC71',2025:'#3498DB',2026:'#9B59B6'};

const totalProd=rawData.reduce((s,d)=>s+d[2],0);
const totalImmessa=rawData.reduce((s,d)=>s+d[5],0);
const totalAutocons=rawData.reduce((s,d)=>s+d[6],0);
const avgAutoPerc=(totalAutocons/(totalProd||1)*100).toFixed(1);
const bestRow=rawData.reduce((a,b)=>b[2]>a[2]?b:a);
const avgCost=(rawData.reduce((s,d)=>s+d[10],0)/rawData.length).toFixed(3);
const latestCost=rawData[rawData.length-1][10];
const ammortizzato=13688.371;
const daAmm=INVESTIMENTO-ammortizzato;
const ammPerc=(ammortizzato/INVESTIMENTO*100).toFixed(1);

document.getElementById('updateTime').textContent=`Aggiornato: ${new Date().toLocaleString('it-IT')}`;
document.getElementById('kpi-prod').textContent=Math.round(totalProd).toLocaleString('it-IT');
document.getElementById('kpi-prod-sub').textContent=`Media ${Math.round(totalProd/rawData.length)} kWh/mese`;
document.getElementById('kpi-auto').textContent=avgAutoPerc;
document.getElementById('kpi-immessa').textContent=Math.round(totalImmessa).toLocaleString('it-IT');
document.getElementById('kpi-immessa-sub').textContent=`${(totalImmessa/totalProd*100).toFixed(1)}% della produzione`;
document.getElementById('kpi-best').textContent=bestRow[2];
document.getElementById('kpi-best-sub').textContent=`${bestRow[1]} ${bestRow[0]}`;
document.getElementById('kpi-cost').textContent=`â‚¬${avgCost}`;
document.getElementById('kpi-cost-sub').textContent=`Ora: â‚¬${latestCost.toFixed(3)}/kWh`;
document.getElementById('kpi-months').textContent=rawData.length;
document.getElementById('ammRecov').textContent=`â‚¬${ammortizzato.toLocaleString('it-IT',{maximumFractionDigits:0})}`;
document.getElementById('ammRemain').textContent=`â‚¬${daAmm.toLocaleString('it-IT',{maximumFractionDigits:0})}`;
document.getElementById('ammPerc').textContent=`${ammPerc}%`;
document.getElementById('ammPercLabel').textContent=`${ammPerc}% recuperato`;
setTimeout(()=>{document.getElementById('ammBar').style.width=ammPerc+'%';},300);

const kpiAnniEl=document.getElementById('kpiAnni');
anni.forEach(anno=>{const dati=rawData.filter(d=>d[0]===anno);const tot=dati.reduce((s,d)=>s+d[2],0);const immessa=dati.reduce((s,d)=>s+d[5],0);const div=document.createElement('div');div.className='kpi-card';div.innerHTML=`<div class="kpi-label" style="color:${colori[anno]}">${anno}</div><div class="kpi-value" style="color:${colori[anno]};font-size:26px;">${Math.round(tot).toLocaleString('it-IT')}</div><div class="kpi-unit">kWh prodotti</div><div class="kpi-sub">${dati.length} mesi Â· immessa: ${Math.round(immessa)} kWh</div>`;kpiAnniEl.appendChild(div);});

const chartOpts={responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#7A8BA8',font:{family:'Space Mono',size:10}}}},scales:{x:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'#7A8BA8',font:{family:'Space Mono',size:10}}},y:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'#7A8BA8',font:{family:'Space Mono',size:10}}}}};

new Chart(document.getElementById('chartProduzione'),{type:'line',data:{labels:mesiNomi,datasets:anni.map(anno=>{const m={};rawData.filter(d=>d[0]===anno).forEach(d=>{m[d[1]]=d[2];});return{label:anno.toString(),data:mesiNomi.map(n=>m[n]||null),borderColor:colori[anno],backgroundColor:colori[anno]+'22',tension:0.4,borderWidth:2,pointRadius:3,spanGaps:true};})},options:chartOpts});

const totPerAnno=anni.map(a=>rawData.filter(d=>d[0]===a).reduce((s,d)=>s+d[2],0));
new Chart(document.getElementById('chartAnni'),{type:'bar',data:{labels:anni.map(String),datasets:[{label:'kWh annui',data:totPerAnno,backgroundColor:anni.map(a=>colori[a]+'99'),borderColor:anni.map(a=>colori[a]),borderWidth:2,borderRadius:6}]},options:{...chartOpts,plugins:{legend:{display:false}}}});

new Chart(document.getElementById('chartCosto'),{type:'line',data:{labels:rawData.map(d=>`${d[1].substring(0,3)}'${String(d[0]).substring(2)}`),datasets:[{label:'â‚¬/kWh',data:rawData.map(d=>d[10]),borderColor:'#F5A623',backgroundColor:'rgba(245,166,35,0.1)',tension:0.3,borderWidth:2,pointRadius:2,fill:true}]},options:{...chartOpts,plugins:{legend:{display:false}}}});

const d2024=rawData.filter(d=>d[0]===2024);const auto2024=d2024.reduce((s,d)=>s+d[6],0);const imm2024=d2024.reduce((s,d)=>s+d[5],0);
new Chart(document.getElementById('chartDonut'),{type:'doughnut',data:{labels:['Autoconsumo','Immessa in rete'],datasets:[{data:[Math.round(auto2024),Math.round(imm2024)],backgroundColor:['#2ECC71','#3498DB'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#7A8BA8',font:{family:'Space Mono',size:10},padding:16}}}}});

let selectedYear=2025;let chartMensileInst=null;
function buildYearPills(){const c=document.getElementById('yearPills');c.innerHTML='';anni.forEach(a=>{const btn=document.createElement('button');btn.className='year-pill'+(a===selectedYear?' active':'');btn.textContent=a;btn.onclick=()=>{selectedYear=a;buildYearPills();renderMensile();};c.appendChild(btn);});}

function renderMensile(){
const dati=rawData.filter(d=>d[0]===selectedYear);
document.getElementById('mensileTitle').textContent=`Dettaglio ${selectedYear}`;
if(chartMensileInst)chartMensileInst.destroy();
chartMensileInst=new Chart(document.getElementById('chartMensile'),{type:'bar',data:{labels:dati.map(d=>d[1]),datasets:[{label:'Produzione FV',data:dati.map(d=>d[2]),backgroundColor:'rgba(245,166,35,0.7)',borderRadius:4},{label:'Autoconsumo',data:dati.map(d=>d[6]),backgroundColor:'rgba(46,204,113,0.7)',borderRadius:4},{label:'Immessa',data:dati.map(d=>d[5]),backgroundColor:'rgba(52,152,219,0.5)',borderRadius:4},{label:'Da rete',data:dati.map(d=>d[3]),backgroundColor:'rgba(231,76,60,0.4)',borderRadius:4}]},options:chartOpts});

const tbody=document.getElementById('tbodyMensile');tbody.innerHTML='';
let totProd=0,totAuto=0,totImm=0,totRete=0,totBoll=0,totCosto=0;
dati.forEach(d=>{totProd+=d[2];totAuto+=d[6];totImm+=d[5];totRete+=d[3];totBoll+=d[8];totCosto+=d[9];const tr=document.createElement('tr');tr.innerHTML=`<td>${d[1]}</td><td class="num warn">${d[2]}</td><td class="num good">${d[6]}</td><td class="num" style="color:var(--blue)">${d[5]}</td><td class="num">${Math.round(d[3])}</td><td class="num">${d[8]}</td><td class="num">â‚¬${d[10].toFixed(3)}</td><td class="num">â‚¬${d[9].toFixed(0)}</td>`;tbody.appendChild(tr);});
const trTot=document.createElement('tr');trTot.style.fontWeight='700';trTot.style.borderTop='2px solid rgba(245,166,35,0.3)';trTot.innerHTML=`<td style="color:var(--sun)">TOTALE ${selectedYear}</td><td class="num warn">${Math.round(totProd)}</td><td class="num good">${Math.round(totAuto)}</td><td class="num" style="color:var(--blue)">${Math.round(totImm)}</td><td class="num">${Math.round(totRete)}</td><td class="num">${Math.round(totBoll)}</td><td class="num">â‚¬${(totCosto/dati.length).toFixed(3)} avg</td><td class="num">â‚¬${Math.round(totCosto)}</td>`;tbody.appendChild(trTot);
}

buildYearPills();renderMensile();

new Chart(document.getElementById('chartConfronto'),{type:'line',data:{labels:mesiNomi,datasets:anni.map(anno=>{const mm={};rawData.filter(d=>d[0]===anno).forEach(d=>mm[d[1]]=d[2]);return{label:anno.toString(),data:mesiNomi.map(m=>mm[m]||null),borderColor:colori[anno],backgroundColor:colori[anno]+'15',tension:0.4,borderWidth:2,pointRadius:3,spanGaps:true,fill:false};})},options:chartOpts});

new Chart(document.getElementById('chartCostoAnno'),{type:'line',data:{labels:mesiNomi,datasets:anni.map(anno=>{const mm={};rawData.filter(d=>d[0]===anno).forEach(d=>mm[d[1]]=d[10]);return{label:anno.toString(),data:mesiNomi.map(m=>mm[m]||null),borderColor:colori[anno],tension:0.4,borderWidth:2,pointRadius:3,spanGaps:true};})},options:chartOpts});

// ===================== LIVE INVERTER DATA =====================
function loadLiveData() {
  gasGet('live').then(data => { if (data) updateLiveUI(data); });
  gasGet('history', { hours: 24 }).then(data => { if (data && data.length) updateLiveCharts(data); });
}

function updateLiveUI(data) {
  if (!data || data.error) return;
  document.getElementById('liveTimestamp').textContent = data.timestamp || 'N/A';
  document.getElementById('statusBadge').textContent = 'LIVE';
  
  document.getElementById('live-powerpv').textContent = Number(data.powerpv).toFixed(1);
  document.getElementById('live-powerbatt').textContent = Number(data.powerbatt).toFixed(1);
  document.getElementById('live-powergrid').textContent = Number(data.powergrid).toFixed(1);
  document.getElementById('live-powerhouse').textContent = Number(data.powerhouse).toFixed(1);
  
  document.getElementById('live-energypv').textContent = Number(data.energy_pv).toFixed(1);
  document.getElementById('live-energyhouse').textContent = Number(data.energy_powerhouse).toFixed(1);
  document.getElementById('live-battdischa').textContent = Number(data.energy_battery_discha).toFixed(1);
  document.getElementById('live-battchar').textContent = Math.abs(Number(data.energy_battery_char)).toFixed(1);
  document.getElementById('live-gridcons').textContent = Number(data.energy_grid_consumed).toFixed(1);
  document.getElementById('live-gridfeed').textContent = Math.abs(Number(data.energy_grid_feed_in)).toFixed(1);
  // Prezzi energia (letti dagli input editabili)
const prezzoAcquisto = parseFloat(document.getElementById('price-acquisto').value) || 0.28;
const prezzoVendita = parseFloat(document.getElementById('price-vendita').value) || 0.10;

const euroPV = Number(data.energy_pv) * prezzoAcquisto;
const euroCons = Number(data.energy_grid_consumed) * prezzoAcquisto;
const euroFeed = Math.abs(Number(data.energy_grid_feed_in)) * prezzoVendita;

document.getElementById('live-euro-pv').textContent = euroPV.toFixed(2);
document.getElementById('live-euro-cons').textContent = euroCons.toFixed(2);
document.getElementById('live-euro-feed').textContent = euroFeed.toFixed(2);
  const selfSuff = Number(data.self_sufficiency) || 0;
  document.getElementById('live-selfsuff').textContent = selfSuff.toFixed(0) + '%';
  document.getElementById('live-gauge').style.setProperty('--gauge-pct', selfSuff);
  
  const battPct = Number(data.percentbattery) || 0;
  document.getElementById('live-battpct').textContent = battPct + '%';
  document.getElementById('live-battfill').style.height = battPct + '%';
}

function updateLiveCharts(historyData) {
  if (!historyData || !historyData.length) return;
  
  const labels = historyData.map(d => {
    const ts = new Date(d.timestamp);
    return ts.getHours().toString().padStart(2,'0') + ':' + ts.getMinutes().toString().padStart(2,'0');
  });
  
  new Chart(document.getElementById('chartLivePower'), {
    type: 'line', data: { labels,
      datasets: [
        {label:'PV',data:historyData.map(d=>d.powerpv),borderColor:'#F5A623',backgroundColor:'rgba(245,166,35,0.1)',tension:0.3,borderWidth:2,pointRadius:0,fill:true},
        {label:'Casa',data:historyData.map(d=>d.powerhouse),borderColor:'#2ECC71',tension:0.3,borderWidth:2,pointRadius:0},
        {label:'Rete',data:historyData.map(d=>d.powergrid),borderColor:'#E74C3C',tension:0.3,borderWidth:2,pointRadius:0},
        {label:'Batteria',data:historyData.map(d=>d.powerbatt),borderColor:'#3498DB',tension:0.3,borderWidth:2,pointRadius:0}
      ]}, options: chartOpts
  });
  
  new Chart(document.getElementById('chartLiveEnergy'), {
    type: 'line', data: { labels,
      datasets: [
        {label:'PV',data:historyData.map(d=>d.energy_pv),borderColor:'#F5A623',tension:0.3,borderWidth:2,pointRadius:0,fill:true,backgroundColor:'rgba(245,166,35,0.1)'},
      ]}, options: chartOpts
  });
  
  new Chart(document.getElementById('chartLiveSelfSuff'), {
    type: 'line', data: { labels,
      datasets: [{label:'%',data:historyData.map(d=>d.self_sufficiency),borderColor:'#2ECC71',backgroundColor:'rgba(46,204,113,0.15)',tension:0.3,borderWidth:2,pointRadius:0,fill:true}]
    }, options: {...chartOpts, scales:{...chartOpts.scales, y:{...chartOpts.scales.y, min:0, max:100}}}
  });
  
  new Chart(document.getElementById('chartLiveBattery'), {
    type: 'line', data: { labels,
      datasets: [{label:'%',data:historyData.map(d=>d.percentbattery),borderColor:'#3498DB',backgroundColor:'rgba(52,152,219,0.15)',tension:0.3,borderWidth:2,pointRadius:0,fill:true}]
    }, options: {...chartOpts, scales:{...chartOpts.scales, y:{...chartOpts.scales.y, min:0, max:100}}}
  });
}

// Load live data on page load
loadLiveData();
// Auto-refresh every 5 minutes
setInterval(loadLiveData, 300000);

// ===================== PREZZI ENERGIA =====================
let priceDebounce = null;

function loadPrices() {
  gasGet('prices').then(prices => {
    if (prices && !prices.error) {
      document.getElementById('price-acquisto').value = prices.acquisto;
      document.getElementById('price-vendita').value = prices.vendita;
    }
  });
}

function savePrices() {
  const acquisto = parseFloat(document.getElementById('price-acquisto').value);
  const vendita = parseFloat(document.getElementById('price-vendita').value);
  if (isNaN(acquisto) || isNaN(vendita)) return;

  gasGet('savePrices', { acquisto, vendita }).then(() => {
    const badge = document.getElementById('priceSaved');
    badge.classList.add('show');
    setTimeout(() => badge.classList.remove('show'), 2000);
  });
}

function onPriceChange() {
  // Ricalcola i valori economici subito
  loadLiveData();
  // Salva su Sheets con debounce (500ms)
  clearTimeout(priceDebounce);
  priceDebounce = setTimeout(savePrices, 500);
}

document.getElementById('price-acquisto').addEventListener('input', onPriceChange);
document.getElementById('price-vendita').addEventListener('input', onPriceChange);

// Carica prezzi all'avvio
loadPrices();

function switchTab(name){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  event.target.classList.add('active');
}

// Service Worker (PWA offline)
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(e => console.warn('SW:', e));
}
</script>
</body>
</html>